<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>Example Scenario - Aruco Autonomous Drones</title>
<link href="../../css/theme.css" rel="stylesheet"/>
<link href="../../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
<link href="../../kbd.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "Example Scenario";
        var mkdocs_page_input_path = "simulation/example.md";
        var mkdocs_page_url = null;
      </script>
<!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../.."> Aruco Autonomous Drones
        </a><div role="search">
<form action="../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<p class="caption"><span class="caption-text">Building Drone</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../drone/drone_basics/">Introduction to Drones</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../drone/build_qav250_exercise/">QAV250 Build Guide</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Simulation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro_to_linux/">A Brief Introduction to Linux</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../intro_ros2_uav/">Intro to ROS2 and UAVs</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation/">Project Installation</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="#">Example Scenario</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#running-the-simulator">6.1 Running the simulator</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#what-does-the-simulator-run">6.1.1 What does the simulator run</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#controlling-with-teleoperation">6.1.2 Controlling with teleoperation</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-example-autonomous-mission">6.1.3 Running the example autonomous mission</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#stopping-the-simulator">6.1.4 Stopping the simulator</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#disecting-the-controller">6.2 Disecting the controller</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#modifying-the-controller">6.3 Modifying the controller</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#transferring-this-controller">6.4 Transferring this controller</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../..">Aruco Autonomous Drones</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href="../.."></a></li>
<li class="breadcrumb-item">Simulation</li>
<li class="breadcrumb-item active">Example Scenario</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/ucl-delta/project_gazebo_aruco/edit/master/docs/simulation/example.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="example-mission"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.</span> Example Mission<a class="headerlink" href="#example-mission" title="Permanent link">¶</a></h1>
<p>Following on from the installation, let us talk about running the example mission. </p>
<div class="toc">
<ul>
<li><a href="#example-mission">6. Example Mission</a><ul>
<li><a href="#running-the-simulator">6.1 Running the simulator</a><ul>
<li><a href="#what-does-the-simulator-run">6.1.1 What does the simulator run</a></li>
<li><a href="#controlling-with-teleoperation">6.1.2 Controlling with teleoperation</a></li>
<li><a href="#running-the-example-autonomous-mission">6.1.3 Running the example autonomous mission</a></li>
<li><a href="#stopping-the-simulator">6.1.4 Stopping the simulator</a></li>
</ul>
</li>
<li><a href="#disecting-the-controller">6.2 Disecting the controller</a></li>
<li><a href="#modifying-the-controller">6.3 Modifying the controller</a></li>
<li><a href="#transferring-this-controller">6.4 Transferring this controller</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="running-the-simulator"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.1</span> Running the simulator<a class="headerlink" href="#running-the-simulator" title="Permanent link">¶</a></h2>
<p>In your selected environment, start the aerostack2 simulation environment </p>
<pre><code>cd /ros2/project_gazebo_aruco
./launch_as2.bash -s -t -v
</code></pre>
<p>The <code>launch_as2.bash</code> file runs a bash script which controls what elements are also started up. </p>
<blockquote>
<p>The <code>-s</code> indicates that the system should be launched in simulation mode. The <code>-t</code> opens up the teleoperation remote control window to control the drone. The <code>-v</code> opens up a visualisation software called rviz2.</p>
</blockquote>
<p><img alt="Running simulation environment" src="../images/example/simulation_running.png"/></p>
<h3 id="what-does-the-simulator-run"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.1.1</span> What does the simulator run<a class="headerlink" href="#what-does-the-simulator-run" title="Permanent link">¶</a></h3>
<p>The aerostack simulator runs a number of different modules for ensuring successful flight this includes:</p>
<ul>
<li>Platform Interface</li>
<li>State Estimation</li>
<li>Motion Controllers</li>
<li>Behaviour Controllers (Takeoff, Land, Go-To)</li>
</ul>
<p>You can see the status of these other modules if you select the terminal and press <kbd class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-b">B</kbd></kbd> and then press <kbd class="keys"><kbd class="key-0">0</kbd></kbd> ... <kbd class="keys"><kbd class="key-5">5</kbd></kbd>.</p>
<blockquote>
<p>This terminal environment is called <code>tmux</code></p>
</blockquote>
<h3 id="controlling-with-teleoperation"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.1.2</span> Controlling with teleoperation<a class="headerlink" href="#controlling-with-teleoperation" title="Permanent link">¶</a></h3>
<p>Using the <code>-t</code> option will open up the teleoperation panel, allowing you to attempt to manually fly the robot in simulation. </p>
<p><img alt="Using the teleoperation" src="../images/example/teleoperation_panel.png"/></p>
<p>With the teleoperation panel clicked on and selected, you can press the <kbd class="keys"><kbd class="key-t">T</kbd></kbd> key to takeoff. The arrow keys will then control the direction of flight of the drone in position control mode (you tell the drone where specifically to go). </p>
<p>Notice how the drone flies around in the simulation and in rviz. Also see how the image within rviz changes! </p>
<p>The image is from a bottom mounted camera on the simulated drone, mirroring the setup you will be building with the real drone. </p>
<p>Play around a fly the drone around! </p>
<p><img alt="teleoperation" src="../images/example/teleoperation.png"/></p>
<h3 id="running-the-example-autonomous-mission"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.1.3</span> Running the example autonomous mission<a class="headerlink" href="#running-the-example-autonomous-mission" title="Permanent link">¶</a></h3>
<p>In the original terminal (Use <kbd class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-b">B</kbd></kbd> + <kbd class="keys"><kbd class="key-5">5</kbd></kbd> ), we can run any scripts we want. The <code>mission_*.py</code> scripts are some examples of these autonomous missions. </p>
<p>To run one of these examples, in the terminal type:</p>
<pre><code>python3 mission_camera.py
</code></pre>
<p>This example mission gives you a camera stream from the drone, takes off and arms the drone and flies it around using a few different methods.</p>
<p>Key points is the use of ROS2 to subscribe to the camera topic published by the drone model. Whenever an image is received, it will run the <code>img_callback</code> function. </p>
<h3 id="stopping-the-simulator"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.1.4</span> Stopping the simulator<a class="headerlink" href="#stopping-the-simulator" title="Permanent link">¶</a></h3>
<p>In order to stop the simulator cleanly, in any terminal run the <code>./stop.bash</code> script. </p>
<pre><code>./stop.bash
</code></pre>
<p>This will stop all containers and relevant programs to the simulator in a clean manner. </p>
<p>Sometimes the simulated drone will go into an unrecoverable state - you may need to resart the simulator. </p>
<h2 id="disecting-the-controller"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.2</span> Disecting the controller<a class="headerlink" href="#disecting-the-controller" title="Permanent link">¶</a></h2>
<p>Here is the example controller. It is documented! </p>
<pre><code class="language-python">#!/bin/python3

"""
CAMERA SAMPLE MISSION

This file is an example mission which reads from the aerostack drone camera and prints it to screen

It also flies around using position and velocity control camera topic 
"""

# Imports
import time
import rclpy
import argparse
from as2_python_api.drone_interface import DroneInterface

from rclpy.qos import qos_profile_sensor_data
from sensor_msgs.msg import Image, CameraInfo

from cv_bridge import CvBridge
import cv2 

######## Drone Control Class ###################
class DroneMotionRef(DroneInterface):
    """Drone Interface

    This is the aerostack2 drone interface for connecting to simulated and real drones. 

    It runs as a ROS2 Node which interacts with the currently available ROS2 topics.
    It defines the variables that represent a single drone, i.e.
    - Platform Information
    - Vehicle Pose and Twist (angular velocity)
    - Functions to control the hardware of the drone (arm, disarm, change mode, estop)

    It also contains some modules for flying the drone, this includes:
    - Takeoff, Landing (self.takeoff, self.land)
    - GoTo position control (self.go_to) [https://github.com/aerostack2/aerostack2/blob/main/as2_python_api/as2_python_api/modules/go_to_module.py]
    - FollowPath module (self.follow_path) [https://github.com/aerostack2/aerostack2/blob/main/as2_python_api/as2_python_api/modules/follow_path_module.py]

    Other module exist which could be used to. Their interfaces and functions can be referenced most easily in the code. 

    Some Documentation is here: https://aerostack2.github.io/_09_development/_api_documentation/temp_ws/src/as2_python_api/docs/source/as2_python_api.html 
    The Source Code is here: https://github.com/aerostack2/aerostack2/tree/main/as2_python_api 

    Drone Interface Base.py: https://github.com/aerostack2/aerostack2/blob/main/as2_python_api/as2_python_api/drone_interface_base.py 
    Drone Interface.py: https://github.com/aerostack2/aerostack2/blob/main/as2_python_api/as2_python_api/drone_interface.py
    """

    def __init__(self, name, verbose=False, use_sim_time=False):
        super().__init__(name, verbose, use_sim_time)

        # ROS2 create a subscription to the raw image of the sensors.
        # This details the ros message type (Image), the name of the topic
        # And the function that should be called when a message is received on this topic
        self.create_subscription(Image, "sensor_measurements/hd_camera/image_raw", self.img_callback, qos_profile_sensor_data)

        # CV Bridge is a set of functions to convert to and from ROS images to Opencv images
        self.br = CvBridge()

    def img_callback(self, data):
        """Image Callback Function

        The image message is defined here: https://github.com/ros2/common_interfaces/blob/rolling/sensor_msgs/msg/Image.msg 

        Args:
            data (sensor_msgs.msg.Image): The received image message 
        """
        self.get_logger().info('Receiving video frame', once=True) # Log Once

        # Convert the image message to a Opencv image frame
        current_frame = self.br.imgmsg_to_cv2(data)

        # Show the frame in a window
        cv2.imshow("camera", current_frame)   
        cv2.waitKey(1) # Wait a millisecond 

    def run_test(self):
        """ Run the mission """

        # Set the drone to offboard mode. This prepares the drone to receive
        # commands from outside of the flight controller. 
        self.offboard()
        self.get_logger().info("Offboard Mode")

        # Arming the drone powers up the motors to prepare for flight
        self.arm()
        self.get_logger().info("Armed!")

        # Takeoff to 1 meter
        self.get_logger().info("Taking Off!")
        res = self.takeoff(height=1.0, speed=0.5)
        if res:
            self.get_logger().info("Take off complete")
        else:
            self.get_logger().info("Take off Failed, exiting")
            return

        # Wait a little bit
        time.sleep(1.0)

        # Position Control fly around a bit
        speed = 1.5
        self.go_to.go_to_point([1, 0, 1.0], speed=speed)
        self.get_logger().info("Point 1")
        self.go_to.go_to_point([2, 0, 2.0], speed=speed)
        self.get_logger().info("Point 2")
        self.go_to.go_to_point([3, 0, 3.0], speed=speed)
        self.get_logger().info("Point 3")
        self.go_to.go_to(3.0, -1.0, 2.5, speed=speed)
        self.get_logger().info("Point 4")
        self.go_to.go_to_point_with_yaw([4, 1, 3.0], angle=45.0, speed=speed)
        self.get_logger().info("Point 5")
        self.go_to.go_to_point_with_yaw([3, -2, 2.0], angle=-45.0, speed=speed)
        self.get_logger().info("Point 6")
        self.go_to.go_to_point_with_yaw([0, 0, 1.0], angle=0.0, speed=speed)
        self.get_logger().info("Point 7")

        self.land()

############# Running the mission and Entrypoint #################################
if __name__ == '__main__':
    parser = argparse.ArgumentParser(
    description="Starts camera mission")
    parser.add_argument('-s', '--simulated',
                        action='store_true', default=False)
    parser.add_argument('-n', '--drone_name', default="cf0")
    args = parser.parse_args()

    if args.simulated:
        print("Mission running in simulation mode")
    else:
        print("Mission running in real mode")

    # Starts ROS2 Node in a script
    rclpy.init()

    # Create the drone object. Connects to the real/simulated drone and runs tests
    uav = DroneMotionRef(args.drone_name, verbose=True)

    # Runs the UAV TEST function
    uav.run_test()

    # Shuts down the UAV
    uav.shutdown()

    # Stop ROS2 Node
    rclpy.shutdown()

    print("Clean exit")
    exit(0)

</code></pre>
<h2 id="modifying-the-controller"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3</span> Modifying the controller<a class="headerlink" href="#modifying-the-controller" title="Permanent link">¶</a></h2>
<p>Now try and modify this controller by making it go to different places at different speeds.</p>
<p>This would be a good time to try an automate any computer vision or detection algorithms inside this python script. </p>
<h2 id="transferring-this-controller"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.4</span> Transferring this controller<a class="headerlink" href="#transferring-this-controller" title="Permanent link">¶</a></h2>
<p>To transfer this controller to real drone, all that is needed is to copy this python mission file to the running machine. </p>
</div>
</div><footer>
<div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-left" href="../installation/" title="Project Installation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
<p>Copyright © 2024 University College London AML Lab</p>
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span>
<a class="fa fa-github" href="https://github.com/ucl-delta/project_gazebo_aruco" style="color: #fcfcfc"> GitHub</a>
</span>
<span><a href="../installation/" style="color: #fcfcfc">« Previous</a></span>
</span>
</div>
<script src="../../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "../..";</script>
<script src="../../js/theme_extra.js"></script>
<script src="../../js/theme.js"></script>
<script src="../../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
</body>
</html>
